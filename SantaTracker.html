<!DOCTYPE html>
<html>
<head>
  <meta charset='utf-8' />
  <title>RCA Santa Tracker</title>
  <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
  <meta itemprop="description" content="Santa Tracker">
  <meta itemprop="image" content='images/santa.png'>
  <script src='https://api.tiles.mapbox.com/mapbox-gl-js/v0.26.0/mapbox-gl.js'></script>
  <script src='https://cdnjs.cloudflare.com/ajax/libs/fetch/1.0.0/fetch.min.js'></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/timeago.js/2.0.3/timeago.min.js"></script>
  <script src="https://api.mapbox.com/mapbox-gl-js/v3.0.0/mapbox-gl.js"></script>
  <link href='https://api.tiles.mapbox.com/mapbox-gl-js/v0.26.0/mapbox-gl.css' rel='stylesheet' />
  <!--define the style of the page-->
  <style>
    body {
      margin: 0;
      padding: 0;
    }
    #map {
      position: absolute;
      top: 0;
      bottom: 0;
      width: 100%;
    }
    #marker {
      background-size: cover;
      width: 64px;
      height: 48px;
      cursor: pointer;
    }
    .mapboxgl-popup {
      max-width: 200px;
    }
  </style>
</head>

<body>
  <div id="map"></div>
  
  <script>
      // Change this to your ThingSpeak channel ID.
      var THINGSPEAK_CHANNEL_ID = 2350435;
      // By default it'll show the last 500 locations logged. Change to more or less.
      var NUMBER_OF_POINTS = 500;
      // You can probably get by without changing this mapbox token but if you notice
      // any rate limiting you can change it here.
      var MAPBOX_TOKEN = 'pk.eyJ1IjoiYXN0cmljIiwiYSI6ImNscDV2YnV5ZTA5cDQyaXIzd3NlZmFhcWMifQ.TtsXy2_vUB_sFqb1zL0e0g';
  
      mapboxgl.accessToken = MAPBOX_TOKEN;
      var map = new mapboxgl.Map({
          container: 'map',
          style: 'mapbox://styles/mapbox/streets-v9',
          center: [-121.324180, 38.565227],
          zoom: 16
     });
     map.addControl(new mapboxgl.NavigationControl());
     
      map.on('load', async () => {
          // Get the initial location of the International Space Station (ISS).
          var geojson = await getLocation();

          map.addSource('prepath', {
            type: 'geojson',
            data:{
               "type": "Feature",
               "properties": {},
               "geometry": {
                  "type": "LineString",
                  "coordinates": [
                  [-121.324180, 38.565227],
                  [-121.324534, 38.565822],
                  [-121.324846, 38.566232],
                  [-121.325151, 38.566556],
                  [-121.325343, 38.566745],
                  [-121.324682, 38.567133],
                  [-121.324074, 38.567452],
                  [-121.323358, 38.567792],
                  [-121.322603, 38.568131],
                  [-121.321909, 38.568410],
                  [-121.321689, 38.568477],
                  [-121.321761, 38.568691],
                  [-121.321914, 38.568938],
                  [-121.322000, 38.569092],
                  [-121.321536, 38.569274],
                  [-121.321308, 38.569308],
                  [-121.321069, 38.569276],
                  [-121.320806, 38.569214],
                  [-121.320101, 38.569075],
                  [-121.319519, 38.569052],
                  [-121.319028, 38.569040],
                  [-121.319015, 38.569730],
                  [-121.319004, 38.571046],
                  [-121.320889, 38.571065],
                  [-121.323686, 38.571089],
                  [-121.324040, 38.571061],
                  [-121.324206, 38.571027],
                  [-121.324445, 38.570952],
                  [-121.324555, 38.570910],
                  [-121.326465, 38.569973], 
                  [-121.326614, 38.569878],
                  [-121.326708, 38.569776],
                  [-121.326778, 38.569657],
                  [-121.326810, 38.569525],
                  [-121.326819, 38.569384],
                  [-121.326828, 38.568343],
                  [-121.326837, 38.567622],
                  [-121.326992, 38.567627],
                  [-121.327200, 38.567625],
                  [-121.327399, 38.567615],
                  [-121.327607, 38.567593],
                  [-121.328098, 38.567490],
                  [-121.328339, 38.567459],
                  [-121.328905, 38.567437],
                  [-121.329146, 38.567418],
                  [-121.329860, 38.567301],
                  [-121.329876, 38.565906],
                  [-121.329505, 38.565917],
                  [-121.329125, 38.566008],
                  [-121.328841, 38.566051],
                  [-121.328549, 38.566057],
                  [-121.328176, 38.566006],
                  [-121.327715, 38.565884],
                  [-121.327695, 38.565186],
                  [-121.327676, 38.564636],
                  [-121.327722, 38.564447],
                  [-121.327760, 38.563417],
                  [-121.327800, 38.562453],
                  [-121.327784, 38.561745],
                  [-121.328262, 38.561741],
                  [-121.328205, 38.561458],
                  [-121.328133, 38.561316],
                  [-121.327987, 38.561177],
                  [-121.327786, 38.561081],
                  [-121.327460, 38.561034],
                  [-121.327174, 38.561045],
                  [-121.326807, 38.561091],
                  [-121.326503, 38.561152],
                  [-121.326367,  38.560833],
                  [-121.326238, 38.560542],
                  [-121.325082, 38.560832],
                  [-121.324654, 38.560973],
                  [-121.324343, 38.561118],
                  [-121.322886, 38.561793],
                  [-121.322292, 38.561084],
                  [-121.322047, 38.561181],
                  [-121.321863, 38.561211],
                  [-121.321650, 38.561214],
                  [-121.320177, 38.561214],
                  [-121.319968, 38.561242],
                  [-121.319804, 38.561298],
                  [-121.319632, 38.561392],
                  [-121.319463, 38.561544],
                  [-121.319354, 38.561710],
                  [-121.319311, 38.561836],
                  [-121.319300, 38.561924],
                  [-121.319295, 38.562489],
                  [-121.319279, 38.563353],
                  [-121.319226, 38.563523],
                  [-121.319163, 38.563647],
                  [-121.319133, 38.563778],
                  [-121.319129, 38.563856],
                  [-121.319138, 38.564002],
                  [-121.318607, 38.563998],
                  [-121.318614, 38.564677],
                  [-121.318624, 38.565121],
                  [-121.318649, 38.565164],
                  [-121.318742, 38.565186],
                  [-121.319654, 38.565184],
                  [-121.320170, 38.565207],
                  [-121.320852, 38.565196],
                  [-121.321639, 38.565189],
                  [-121.322357, 38.565184],
                  [-121.322567, 38.565152],
                  [-121.322758, 38.565101],
                  [-121.322938, 38.565025], 
                  [-121.323198, 38.564872],
                  [-121.323398, 38.564749],
                  [-121.323537, 38.564681],
                  [-121.323674, 38.564627],
                  [-121.323830, 38.564571],
                  [-121.324015, 38.564921],
                  [-121.324180, 38.565227]  
                  ]
               }
            }
          });
          // Add the ISS location as a source.
          map.addSource('iss', {
              type: 'geojson',
              data: geojson
          });

          map.addLayer({
            "id": "prepath",
            "type": "line",
            "source": "prepath",
            "layout": {
              "line-join": "round",
              "line-cap": "round"
            },
            "paint": {
              "line-color": "#FF0000",
              "line-width": 8
            }
          });

          // Add the rocket symbol layer to the map.
          map.addLayer({
            "id": "iss",
            "type": "line",
            "source": "iss",
            "layout": {
              "line-join": "round",
              "line-cap": "round"
            },
            "paint": {
              "line-color": "#080",
              "line-width": 8
            }
          });
  
          map.loadImage(
           'https://daviddiazgames.com/images/santa.png',
           (error, image) => {
              if (error) throw error;
   
              // Add the image to the map style.
              map.addImage('santa', image);
   
              // Add a data source containing one point feature.
              map.addSource('point', {
                 'type': 'geojson',
                 'data': {
                    'type': 'FeatureCollection',
                    'features': [
                       {
                          'type': 'Feature',
                          'geometry': {
                             'type': 'Point',
                             'coordinates': geojson.geometry.coordinates[geojson.geometry.coordinates.length-1]
                          }
                       }
                    ]
                 }
              });
              
              // Add a layer to use the image to represent the data.
              map.addLayer({
                 'id': 'points',
                 'type': 'symbol',
                 'source': 'point', // reference the data source
                 'layout': {
                    'icon-image': 'santa', // reference the image
                    'icon-size': 0.05,
                    'icon-rotate': 180
                 }
              });
           }
          );
         
          // Update the source from the API every 2 seconds.
          const updateSource = setInterval(async () => {
              geojson = await getLocation(updateSource, geojson);
              map.getSource('iss').setData(geojson);
              map.getSource('point').setData({
                 'type': 'FeatureCollection',
                    'features': [
                       {
                          'type': 'Feature',
                          'geometry': {
                             'type': 'Point',
                             'coordinates': geojson.geometry.coordinates[geojson.geometry.coordinates.length-1]
                          }
                       }
                    ]
                 }
              );
          }, 2000);
          async function getLocation(updateSource, geojson) {
              // Make a GET request to the API and return the location of the ISS.
              try {
                  const response = await fetch(
                    'https://api.thingspeak.com/channels/' + THINGSPEAK_CHANNEL_ID + '/feeds.json?results=' + NUMBER_OF_POINTS,
                      { method: 'GET' }
                  );
                 var sponse = await response.json();
                 var points = sponse.feeds.map(function(point) {
                    return {
                       coords: [parseFloat(point.field3), parseFloat(point.field2)],
                       time: point.created_at
                    };
                 });
                 const monument = points[points.length - 1]
                  // Fly the map to the location.
                  map.flyTo({
                      center: monument.coords,
                      speed: 0.5
                  });
                  points = points.map(function(point) {
                    return point.coords;
                 });

                 var recentTime = monument.time
                  // Return the location of santa as GeoJSON unless.
                  if(geojson === undefined || geojson.properties.time <= recentTime){
                     return {
                        "type": "Feature",
                        "properties": {
                           "time" : recentTime
                        },
                        "geometry": {
                           "type": "LineString",
                           "coordinates": points
                        }
                     };
                  } else {
                     console.log("map rewind caught");
                     return geojson;
                  }
              } catch (err) {
                  // If the updateSource interval is defined, clear the interval to stop updating the source.
                  if (updateSource) clearInterval(updateSource);
                  throw new Error(err);
              }
          }
      });
  </script>
  
  </body>
</html>
